<!DOCTYPE html>
<html lang=" en-US">

<head>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Nathan Byrd">

  <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
  <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  <link rel="stylesheet" href="/assets/css/style.css?v=3eda6ab776cc064dd6200a0d2c326284307e64ce">
  <link rel="icon" href="/assets/images/favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#dd0d1a">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Dungeons of Daggorath">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Dungeons of Daggorath">

  <link rel="apple-touch-icon" href="/assets/images/wizicon48.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/images/wizicon72.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/assets/images/wizicon96.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/images/wizicon144.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/assets/images/wizicon192.png">

  <meta name="msapplication-TitleImage" content="/assets/images/wizicon144.png">
  <meta name="msapplication-TitleColor" content="#dd0d1a">
  <meta name="msapplication-tap-highlight" content="no">
  <link rel="stylesheet"
    href="/assets/css/emscripten.css?v=3eda6ab776cc064dd6200a0d2c326284307e64ce">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Dungeons of Daggorath | Webassembly port of the classic Color Computer game, Dungeons of Daggorath</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Dungeons of Daggorath" />
<meta name="author" content="Nathan Byrd" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Webassembly port of the classic Color Computer game, Dungeons of Daggorath" />
<meta property="og:description" content="Webassembly port of the classic Color Computer game, Dungeons of Daggorath" />
<link rel="canonical" href="http://daggorath.online/" />
<meta property="og:url" content="http://daggorath.online/" />
<meta property="og:site_name" content="Dungeons of Daggorath" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Nathan Byrd"},"headline":"Dungeons of Daggorath","description":"Webassembly port of the classic Color Computer game, Dungeons of Daggorath","url":"http://daggorath.online/","@type":"WebSite","name":"Dungeons of Daggorath","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <script src="/assets/js/domlite.js?v=3eda6ab776cc064dd6200a0d2c326284307e64ce"></script>


  <script>
    if ("serviceWorker" in navigator) {
      if (navigator.serviceWorker.controller) {
        console.log("An active service worker found, no need to register");
      } else {
        // Register the service worker with proper baseurl handling
        var baseUrl = "";
        var swPath = baseUrl + "/serviceworker.js";
        var swScope = baseUrl + "/";
        // Handle root case where baseurl is empty
        if (baseUrl === "") {
          swPath = "/serviceworker.js";
          swScope = "/";
        }
        navigator.serviceWorker
          .register(swPath, {
            scope: swScope
          })
          .then(function (reg) {
            console.log("Service worker has been registered for scope: " + reg.scope);
          });
      }
    }
  </script>
</head>

<body>

  <!--
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
      <a class="navbar-brand" href="#">
          <picture style="float:left;">
              <source type="image/webp" srcset="assets/images/dodtext300.webp" media="(min-width: 300px)" title="Dungeons of Daggorath">
                  <source type="image/png" srcset="assets/images/dodtext300.png" media="(min-width: 300px)" title="Dungeons of Daggorath">
                    <a href="index.html"><img src="assets/images/dodtext300.png" alt="Dungeons of Daggorath"></a>
          </picture>
      </a>

      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          
          <a href="about.html" class="nav-item nav-link">About</a>
          <a href="how.html" class="nav-item nav-link">How to Play</a>
          <a href="https://github.com/DungeonsOfDaggorath/DungeonsOfDaggorath.github.io" class="nav-item nav-link"><span class="icon"></span>View on GitHub</a>
        </div>
      </div>
    </nav>
    -->

  <style>
/* Prevent horizontal overflow */
#main_content {
  overflow-x: hidden;
  max-width: 100%;
}

/* Settings Panel Styles */
.settings-panel {
  max-width: 600px;
  margin: 1rem auto;
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 4px;
  text-align: left;
  box-sizing: border-box;
}

.settings-section {
  border-bottom: 1px solid #333;
}

.settings-section:last-child {
  border-bottom: none;
}

.settings-header {
  width: 100%;
  padding: 12px 16px;
  background: #252525;
  border: none;
  color: #b5e853;
  font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
  font-size: 16px;
  text-align: left;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.settings-header:hover {
  background: #2a2a2a;
}

.settings-header:focus {
  outline: 2px solid #b5e853;
  outline-offset: -2px;
}

.accordion-arrow {
  font-size: 18px;
  font-weight: bold;
  color: #63c0f5;
}

.settings-content {
  display: none;
  padding: 16px;
  background: #1a1a1a;
}

.settings-content.open {
  display: block;
}

.settings-content label {
  display: flex;
  align-items: center;
  padding: 8px 0;
  min-height: 44px;
  cursor: pointer;
  color: #eaeaea;
  font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
  font-size: 14px;
  word-break: break-word;
}

.settings-content label:hover {
  color: #b5e853;
}

.settings-content input[type="radio"],
.settings-content input[type="checkbox"] {
  width: 20px;
  height: 20px;
  margin-right: 12px;
  cursor: pointer;
  accent-color: #b5e853;
}

.settings-content input[type="range"] {
  width: 100%;
  height: 8px;
  margin: 10px 0;
  cursor: pointer;
  accent-color: #b5e853;
}

.volume-display {
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #eaeaea;
  font-family: Monaco, monospace;
  font-size: 14px;
}

.volume-value {
  color: #b5e853;
  font-weight: bold;
  min-width: 40px;
  text-align: right;
}

.mod-description {
  font-size: 12px;
  color: #888;
  margin-left: 32px;
  margin-top: -4px;
  margin-bottom: 8px;
}

/* Play Section */
.play-section {
  margin: 1.5rem 0;
  text-align: center;
}

.play-btn {
  font-size: 1.4rem !important;
  padding: 14px 32px !important;
  background: #1a1a1a !important;
  border: 2px solid #b5e853 !important;
  color: #b5e853 !important;
  text-shadow: none;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  transition: all 0.2s ease;
}

.play-btn:hover {
  background: #252525 !important;
  box-shadow: 0 6px 16px rgba(181, 232, 83, 0.3);
  transform: translateY(-1px);
}

.play-btn:active {
  transform: translateY(1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

.install-link {
  margin-top: 0.75rem;
  display: none;
}

.install-link a {
  color: #63c0f5;
  font-size: 0.9rem;
  text-decoration: none;
  opacity: 0.8;
}

.install-link a:hover {
  opacity: 1;
  text-decoration: underline;
}

/* Settings Title */
.settings-title {
  padding: 10px 16px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #666;
  border-bottom: 1px solid #333;
  background: #1a1a1a;
}

/* Navigation Links */
.nav-links {
  margin-top: 1.5rem;
  padding: 1rem 0;
  text-align: center;
  border-top: 1px solid #333;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  gap: 4px 0;
}

.nav-link {
  color: #63c0f5;
  text-decoration: none;
  font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
  font-size: 14px;
  padding: 8px 12px;
  transition: color 0.2s ease;
  white-space: nowrap;
}

.nav-link:hover {
  color: #b5e853;
  text-decoration: none;
}

.nav-separator {
  color: #444;
  margin: 0 4px;
}

/* Mobile responsive */
@media (max-width: 600px) {
  .settings-panel {
    margin: 0.5rem 0;
    border-radius: 0;
    border-left: none;
    border-right: none;
  }
  .settings-header {
    font-size: 14px;
    padding: 10px 12px;
  }
  .settings-content {
    padding: 12px;
  }
  .settings-content label {
    font-size: 13px;
  }
  .mod-description {
    margin-left: 32px;
    font-size: 11px;
  }
  .play-btn {
    font-size: 1.2rem !important;
    padding: 12px 24px !important;
  }
  .nav-separator {
    display: none;
  }
  .nav-link {
    padding: 10px 16px;
  }
}
</style>
<div class="container menu_items" id="info">
  <section id="main_content">
    <picture>
      <source type="image/webp" srcset="assets/images/dodtext300.webp" media="(min-width: 300px)"
        title="Dungeons of Daggorath">
      <source type="image/png" srcset="assets/images/dodtext300.png" media="(min-width: 300px)"
        title="Dungeons of Daggorath">
      <img src="assets/images/dodtext300.png" alt="Dungeons of Daggorath">
    </picture>
    <div id="coi-warning" class="alert alert-warning" style="display:none;">
      <strong>Cross-origin isolation required.</strong> The threaded WebAssembly build needs SharedArrayBuffer support.
      Run the site from a server that sets <code>Cross-Origin-Opener-Policy: same-origin</code> and
      <code>Cross-Origin-Embedder-Policy: require-corp</code>.
      For local testing with the Emscripten SDK run <code>make serve</code> or <code>make serve-local</code>.
    </div>

    <!-- Play Button - Primary Action -->
    <div class="play-section">
      <button id="readyPlayerOne" type="button" class="btn-lg btn-primary btn play-btn">Play Dungeons of Daggorath</button>
      <div id="installapp" class="install-link"><a href="#" id="install_link">Install App</a></div>
    </div>

    <!-- Settings Panel -->
    <div id="settings_panel" class="settings-panel">
      <div class="settings-title">Game Options</div>
      <!-- Graphics Section -->
      <div class="settings-section">
        <button class="settings-header" type="button" data-section="graphics">
          Graphics <span class="accordion-arrow">+</span>
        </button>
        <div class="settings-content" id="graphics-content">
          <label><input type="radio" name="graphics_mode" value="normal_ntsc"> NORMAL - NTSC</label>
          <label><input type="radio" name="graphics_mode" value="normal_ntsc_inv"> NORMAL - NTSC INV</label>
          <label><input type="radio" name="graphics_mode" value="normal_rgb"> NORMAL - RGB</label>
          <label><input type="radio" name="graphics_mode" value="hires_ntsc"> HIRES - NTSC</label>
          <label><input type="radio" name="graphics_mode" value="hires_ntsc_inv"> HIRES - NTSC INV</label>
          <label><input type="radio" name="graphics_mode" value="hires_rgb"> HIRES - RGB</label>
          <label><input type="radio" name="graphics_mode" value="vector"> VECTOR</label>
        </div>
      </div>

      <!-- Volume Section -->
      <div class="settings-section">
        <button class="settings-header" type="button" data-section="volume">
          Volume <span class="accordion-arrow">+</span>
        </button>
        <div class="settings-content" id="volume-content">
          <div class="volume-display">
            <span>Volume</span>
            <span class="volume-value" id="volume-value">128</span>
          </div>
          <input type="range" id="volume-slider" name="volume" min="0" max="128" value="128">
        </div>
      </div>

      <!-- Mods Section -->
      <div class="settings-section">
        <button class="settings-header" type="button" data-section="mods">
          Mods <span class="accordion-arrow">+</span>
        </button>
        <div class="settings-content" id="mods-content">
          <label><input type="checkbox" name="mod" value="shield_fix"> Shield Fix</label>
          <div class="mod-description">Fixes shield mechanics bug from original</div>
          <label><input type="checkbox" name="mod" value="vision_scroll"> Vision Scroll</label>
          <div class="mod-description">Vision scrolls with map movement</div>
          <label><input type="checkbox" name="mod" value="mark_doors"> Mark Doors on Maps</label>
          <div class="mod-description">Shows doors on scroll maps</div>
          <label><input type="checkbox" name="mod" value="creatures_ignore_objects"> Creatures Ignore Objects</label>
          <div class="mod-description">Creatures don't interact with objects</div>
          <label><input type="checkbox" name="mod" value="creatures_insta_regen"> Creatures Insta-Regen</label>
          <div class="mod-description">Creatures regenerate instantly</div>
          <label><input type="checkbox" name="mod" value="random_mazes"> Random Mazes</label>
          <div class="mod-description">Enables random maze generation</div>
          <label><input type="checkbox" name="mod" value="modern_controls"> Modern Controls</label>
          <div class="mod-description">Arrow keys + TAB for controls</div>
        </div>
      </div>
    </div>

    <!-- Navigation Links -->
    <nav class="nav-links">
      <a href="about.html" class="nav-link">About</a>
      <span class="nav-separator">|</span>
      <a href="how.html" class="nav-link">How to Play</a>
      <span class="nav-separator">|</span>
      <a href="https://github.com/DungeonsOfDaggorath/DungeonsOfDaggorath.github.io" class="nav-link">View on GitHub</a>
    </nav>
  </section>
</div>
<div id="game_area">
  <div class="column_width">
    <div class="width_sizer">
      <div id="frame">
        <figure id=spinner style=overflow:visible>
          <div class=spinner></div>
          <center style=margin-top:.5em><strong>emscripten</strong></center>
        </figure>
        <div class=emscripten id=status>Downloading...</div>
        <div class=emscripten>
          <progress hidden id=progress max=100 value=0></progress>
        </div>
        <canvas class=emscripten id=canvas oncontextmenu=event.preventDefault()></canvas>
      </div>
      <button id="stopdemo" type="button" style="display:none" class="btn-lg btn-primary btn">Stop Demo / Start
        game</button><br />
      <div id="button_area">
      </div>
      <div id="second_area">
      </div>
      <div id="inventory_area">
      </div>
      <div id="menu_nav_area" style="display:none;">
      </div>
      <div id="incant_input_area" style="display:none;">
        <label for="incant_word">Enter magic word:</label>
        <input type="text" id="incant_word" autocomplete="off" autocapitalize="characters" />
        <button id="incant_go">GO</button>
        <button id="incant_cancel">CANCEL</button>
      </div>
    </div>
  </div>
</div>
<script>

  let deferredPrompt;

  window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent the mini-infobar from appearing on mobile
    e.preventDefault();
    // Stash the event so it can be triggered later.
    deferredPrompt = e;
    // update UI notify the user they can install the PWA
    $("#installapp").show();
  });

  $("#install_link").click(function (event) {
    event.preventDefault();

    if (deferredPrompt == null) {
      console.log("Something went wrong here, user clicked the link but no waiting event.");
      return;
    }

    $("#installapp").hide();
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        console.log("User accepted the install prompt");
      }
      else {
        console.log("User dismissed the install prompt");
        $("#installapp").show();
      }
    });
  });

  // Game Configuration Module
  var GameConfig = {
    validGraphicsModes: ['vector', 'normal_rgb', 'normal_ntsc', 'normal_ntsc_inv', 'hires_rgb', 'hires_ntsc', 'hires_ntsc_inv'],
    validMods: ['shield_fix', 'vision_scroll', 'mark_doors', 'creatures_ignore_objects', 'creatures_insta_regen', 'random_mazes', 'modern_controls'],
    validCheats: ['torch_always_lit', 'ring_always_works', 'creature_scaling', 'mithril_items', 'easy_reveal', 'invulnerable'],

    // Parse URL parameters into settings object
    parseParams: function() {
      var params = new URLSearchParams(window.location.search);
      var settings = {
        graphics_mode: null,
        volume: null,
        mods: [],
        cheats: []
      };

      // Graphics mode
      var gm = params.get('graphics_mode');
      if (gm && this.validGraphicsModes.indexOf(gm) !== -1) {
        settings.graphics_mode = gm;
      }

      // Volume
      var vol = params.get('volume');
      if (vol !== null) {
        var v = parseInt(vol, 10);
        if (!isNaN(v) && v >= 0 && v <= 128) {
          settings.volume = v;
        }
      }

      // Mods (can have multiple)
      var mods = params.getAll('mod');
      for (var i = 0; i < mods.length; i++) {
        if (this.validMods.indexOf(mods[i]) !== -1 && settings.mods.indexOf(mods[i]) === -1) {
          settings.mods.push(mods[i]);
        }
      }

      // Cheats (can have multiple)
      var cheats = params.getAll('cheat');
      for (var i = 0; i < cheats.length; i++) {
        if (this.validCheats.indexOf(cheats[i]) !== -1 && settings.cheats.indexOf(cheats[i]) === -1) {
          settings.cheats.push(cheats[i]);
        }
      }

      return settings;
    },

    // Build pipe-delimited config string for C++
    buildConfigString: function(settings) {
      var parts = [];

      if (settings.graphics_mode) {
        parts.push('graphics_mode=' + settings.graphics_mode);
      }
      if (settings.volume !== null) {
        parts.push('volume=' + settings.volume);
      }
      for (var i = 0; i < settings.mods.length; i++) {
        parts.push('mod=' + settings.mods[i]);
      }
      for (var i = 0; i < settings.cheats.length; i++) {
        parts.push('cheat=' + settings.cheats[i]);
      }

      return parts.join('|');
    },

    // Read current form values
    readFormValues: function() {
      var settings = {
        graphics_mode: null,
        volume: null,
        mods: [],
        cheats: []
      };

      // Graphics mode (radio)
      var graphicsRadio = document.querySelector('input[name="graphics_mode"]:checked');
      if (graphicsRadio) {
        settings.graphics_mode = graphicsRadio.value;
      }

      // Volume (range)
      var volumeSlider = document.getElementById('volume-slider');
      if (volumeSlider) {
        settings.volume = parseInt(volumeSlider.value, 10);
      }

      // Mods (checkboxes)
      var modCheckboxes = document.querySelectorAll('input[name="mod"]:checked');
      modCheckboxes.forEach(function(cb) {
        settings.mods.push(cb.value);
      });

      return settings;
    },

    // Update URL with settings (causes page reload)
    updateUrl: function(settings) {
      var params = new URLSearchParams();

      if (settings.graphics_mode) {
        params.set('graphics_mode', settings.graphics_mode);
      }
      if (settings.volume !== null && settings.volume !== 128) {
        params.set('volume', settings.volume);
      }
      for (var i = 0; i < settings.mods.length; i++) {
        params.append('mod', settings.mods[i]);
      }
      // Note: cheats are preserved from current URL but not added via GUI
      var currentCheats = this.parseParams().cheats;
      for (var i = 0; i < currentCheats.length; i++) {
        params.append('cheat', currentCheats[i]);
      }

      var newUrl = window.location.pathname;
      var paramString = params.toString();
      if (paramString) {
        newUrl += '?' + paramString;
      }
      window.location.href = newUrl;
    },

    // Initialize form with current URL params
    initializeForm: function() {
      var settings = this.parseParams();

      // Set graphics mode radio (default to normal_ntsc if not set)
      var graphicsValue = settings.graphics_mode || 'normal_ntsc';
      var graphicsRadio = document.querySelector('input[name="graphics_mode"][value="' + graphicsValue + '"]');
      if (graphicsRadio) {
        graphicsRadio.checked = true;
      }

      // Set volume slider (default to 128)
      var volumeSlider = document.getElementById('volume-slider');
      var volumeDisplay = document.getElementById('volume-value');
      var volumeValue = settings.volume !== null ? settings.volume : 128;
      if (volumeSlider) {
        volumeSlider.value = volumeValue;
      }
      if (volumeDisplay) {
        volumeDisplay.textContent = volumeValue;
      }

      // Set mod checkboxes
      for (var i = 0; i < settings.mods.length; i++) {
        var modCheckbox = document.querySelector('input[name="mod"][value="' + settings.mods[i] + '"]');
        if (modCheckbox) {
          modCheckbox.checked = true;
        }
      }
    }
  };

  var inputCommands = {
    "MOVE": ["FORWARD", "BACK", "LEFT", "RIGHT"],
    "TURN": ["LEFT", "RIGHT", "AROUND"],
    "ATTACK": ["LEFT", "RIGHT"],
    "PULL": ["LEFT", "RIGHT"],
    "GET": ["LEFT", "RIGHT"],
    "STOW": ["LEFT", "RIGHT"],
    "CLIMB": ["UP", "DOWN"],
    "EXAMINE": [],
    "LOOK": [],
    "DROP": ["LEFT", "RIGHT"],
    "USE": ["LEFT", "RIGHT"],
    "REVEAL": ["LEFT", "RIGHT"],
    "INCANT": "INPUT",  // Special: shows text input
    "ZSAVE": [],
    "ZLOAD": [],
    "RESTART": "RESTART"  // Special: stops demo first
  };

  // SDL2 key codes for menu navigation
  var SDL_KEYS = {
    RETURN: 13,
    ESCAPE: 27,
    SPACE: 32,
    UP: 1073741906,
    DOWN: 1073741905,
    LEFT: 1073741904,
    RIGHT: 1073741903
  };

  var statusElement = document.getElementById("status");
  var progressElement = document.getElementById("progress");
  var spinnerElement = document.getElementById("spinner");
  (function () {
    var isolationOK = typeof SharedArrayBuffer !== "undefined" && window.crossOriginIsolated === true;
    var warning = document.getElementById("coi-warning");
    var startButton = document.getElementById("readyPlayerOne");
    if (!isolationOK) {
      if (warning) {
        warning.style.display = "block";
      }
      if (startButton) {
        startButton.disabled = true;
      }
    }
  })();

  var Module = {
    preRun: [],
    postRun: [],
    print: function (text) { console.log(text) },
    printErr: function (text) { console.error("ERROR:", text) },
    noExitRuntime: true,
    // Skip calling main
    noInitialRun: true,
    canvas: function () { var e = document.getElementById("canvas"); e.addEventListener("webglcontextlost", function (e) { alert("WebGL context lost. You will need to reload the page."), e.preventDefault() }, !1); console.log("Canvas initial size", e.width, e.height, "offscreen?", !!e.transferControlToOffscreen, e.getBoundingClientRect()); return e }(),
    setStatus: function (e) { if (Module.setStatus.last || (Module.setStatus.last = { time: Date.now(), text: "" }), e !== Module.setStatus.last.text) { var t = e.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/), n = Date.now(); t && n - Module.setStatus.last.time < 30 || (Module.setStatus.last.time = n, Module.setStatus.last.text = e, t ? (e = t[1], progressElement.value = 100 * parseInt(t[2]), progressElement.max = 100 * parseInt(t[4]), progressElement.hidden = !1, spinnerElement.hidden = !1) : (progressElement.value = null, progressElement.max = null, progressElement.hidden = !0, e || (spinnerElement.hidden = !0)), statusElement.innerHTML = e) } },
    totalDependencies: 0,
    monitorRunDependencies: function (e) { this.totalDependencies = Math.max(this.totalDependencies, e), Module.setStatus(e ? "Preparing... (" + (this.totalDependencies - e) + "/" + this.totalDependencies + ")" : "All downloads complete.") }
  };
  Module.setStatus("Downloading..."), window.onerror = function () { Module.setStatus("Exception thrown, see JavaScript console"), spinnerElement.style.display = "none", Module.setStatus = function (e) { e && Module.printErr("[post-exception status] " + e) } }

  var isDemoFunc = null;
  var isMenuOpenFunc = null;
  var sendKeyFunc = null;
  var controlHandler = null;
  var menuCheckHandler = null;
  var wasMenuOpen = false;

  function updateControls() {
    if (!Module.calledRun || typeof isDemoFunc !== 'function') {
      // Not yet ready, just wait
      return;
    }

    var demoActive = !!isDemoFunc();
    if (!demoActive) {
      // Once the demo is no longer active, hide the stop demo button
      // and show the main controls

      // Stop the control handler as the demo is no longer active
      if (controlHandler) {
        clearInterval(controlHandler);
      }
      $("#stopdemo").hide();
      $("#button_area").show();
      $("#second_area").hide();
      $("#inventory_area").hide();

      // Start menu state polling
      if (!menuCheckHandler && typeof isMenuOpenFunc === 'function') {
        menuCheckHandler = setInterval(checkMenuState, 200);
      }
    }
  }

  function checkMenuState() {
    if (typeof isMenuOpenFunc !== 'function') return;

    var menuOpen = !!isMenuOpenFunc();
    if (menuOpen !== wasMenuOpen) {
      wasMenuOpen = menuOpen;
      if (menuOpen) {
        // Menu just opened - show navigation buttons, hide game buttons
        $("#button_area").hide();
        $("#second_area").hide();
        $("#inventory_area").hide();
        $("#incant_input_area").hide();
        $("#menu_nav_area").show();
      } else {
        // Menu just closed - show game buttons, hide navigation
        $("#menu_nav_area").hide();
        $("#button_area").show();
      }
    }
  }

  function showIncantInput() {
    $("#button_area").hide();
    $("#incant_input_area").show();
    var input = document.getElementById('incant_word');
    input.value = '';
    input.focus();
  }

  function hideIncantInput() {
    $("#incant_input_area").hide();
    $("#button_area").show();
  }

  function submitIncant() {
    var input = document.getElementById('incant_word');
    var word = input.value.trim().toUpperCase();
    hideIncantInput();
    if (word) {
      Module.ccall('sendinput', 'void', ['string'], ["INCANT " + word + "\r"]);
    }
  }

  Module.onRuntimeInitialized = function () {
    console.log('[Module] onRuntimeInitialized');
    isDemoFunc = Module.cwrap('isdemo', 'number', []);
    isMenuOpenFunc = Module.cwrap('ismenuopen', 'number', []);
    sendKeyFunc = Module.cwrap('sendkey', 'void', ['number']);
  };

  $(document).ready(function () {
    console.log('[document.ready] initializing control visibility', window.getComputedStyle(document.getElementById('stopdemo')).display, window.getComputedStyle(document.getElementById('button_area')).display);
    $("#stopdemo").hide();
    $("#button_area").hide();
    $("#second_area").hide();
    $("#inventory_area").hide();
    $("#menu_nav_area").hide();
    $("#incant_input_area").hide();

    // Initialize settings form from URL params
    GameConfig.initializeForm();

    // Accordion toggle handlers
    document.querySelectorAll('.settings-header').forEach(function(header) {
      header.addEventListener('click', function() {
        var section = this.getAttribute('data-section');
        var content = document.getElementById(section + '-content');
        var arrow = this.querySelector('.accordion-arrow');

        if (content.classList.contains('open')) {
          content.classList.remove('open');
          arrow.textContent = '+';
        } else {
          // Close all others first
          document.querySelectorAll('.settings-content').forEach(function(c) {
            c.classList.remove('open');
          });
          document.querySelectorAll('.accordion-arrow').forEach(function(a) {
            a.textContent = '+';
          });
          content.classList.add('open');
          arrow.textContent = '-';
        }
      });
    });

    // Volume slider real-time display update
    var volumeSlider = document.getElementById('volume-slider');
    var volumeDisplay = document.getElementById('volume-value');
    if (volumeSlider && volumeDisplay) {
      volumeSlider.addEventListener('input', function() {
        volumeDisplay.textContent = this.value;
      });
    }

    // Form change handlers - update URL on change (for radio/checkbox)
    document.querySelectorAll('#settings_panel input[type="radio"], #settings_panel input[type="checkbox"]').forEach(function(input) {
      input.addEventListener('change', function() {
        var settings = GameConfig.readFormValues();
        GameConfig.updateUrl(settings);
      });
    });

    // Volume slider - update URL only on release (mouseup/touchend) to avoid rapid reloads
    if (volumeSlider) {
      volumeSlider.addEventListener('change', function() {
        var settings = GameConfig.readFormValues();
        GameConfig.updateUrl(settings);
      });
    }

    $("#readyPlayerOne").click(function () {
      console.log('[readyPlayerOne] clicked');
      $("#stopdemo").show();
      $("#frame").show();
      $("#button_area").hide();
      $("#second_area").hide();
      $("#inventory_area").hide();
      $("#menu_nav_area").hide();
      $("#incant_input_area").hide();
      $("#info").hide();
      if (Module.callMain) {
        Module.callMain([]);
      } else if (Module._main) {
        Module._main();
      }

      // Apply URL configuration AFTER game initialization
      // (loadOptFile has already run, so we can override settings)
      try {
        var applyConfigFunc = Module.cwrap('applyconfig', 'void', ['string']);
        var settings = GameConfig.parseParams();
        var configStr = GameConfig.buildConfigString(settings);
        if (configStr) {
          console.log('[Game] Applying config:', configStr);
          applyConfigFunc(configStr);
        }
      } catch (e) {
        console.warn('[Game] Could not apply config:', e);
      }

      // Set interval to check for demo status
      // to remove the stop demo button when the
      // demo is no longer active
      controlHandler = setInterval(updateControls, 500);
    });


    $("#stopdemo").click(function () {
      console.log('[stopdemo] clicked', window.getComputedStyle(document.getElementById('stopdemo')).display, window.getComputedStyle(document.getElementById('button_area')).display);
      Module.ccall('stopdemo', 'void', []);
      $("#stopdemo").hide();
    });

    // INCANT input handlers
    $("#incant_go").click(submitIncant);
    $("#incant_cancel").click(hideIncantInput);
    // Use native addEventListener since domlite doesn't support .on()
    document.getElementById('incant_word').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitIncant();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        hideIncantInput();
      }
    });

    // Create menu navigation buttons
    var menuNavButtons = [
      { label: '▲', key: SDL_KEYS.UP },
      { label: '▼', key: SDL_KEYS.DOWN },
      { label: 'SELECT', key: SDL_KEYS.RETURN },
      { label: 'BACK', key: SDL_KEYS.ESCAPE }
    ];
    for (var nav of menuNavButtons) {
      (function(keyCode) {
        var navBtn = $('<button/>')
          .text(nav.label)
          .click(function() {
            if (typeof sendKeyFunc === 'function') {
              sendKeyFunc(keyCode);
            }
          });
        $("#menu_nav_area").append(navBtn);
      })(nav.key);
    }

    for (var command in inputCommands) {
      var inputButton = $('<button/>')
        .text(command)
        .click(function () {
          var curText = $(this).text();

          if (typeof (inputCommands[curText]) != 'undefined') {
            // Special case: INCANT shows text input
            if (inputCommands[curText] === "INPUT") {
              showIncantInput();
              return;
            }

            // Special case: RESTART stops demo first then restarts
            if (inputCommands[curText] === "RESTART") {
              Module.ccall('stopdemo', 'void', []);
              Module.ccall('sendinput', 'void', ['string'], ["RESTART\r"]);
              return;
            }

            if (inputCommands[curText].length == 0) {
              // Single command
              Module.ccall('sendinput', 'void', ['string'], [curText + "\r"]);
              return;
            }


            $("#second_area").empty();
            $("#button_area").hide();
            $("#inventory_area").hide();
            for (var second of inputCommands[curText]) {
              var secondInputButton = $('<button/>')
                .text(curText + " " + second)
                .click(function () {
                  var btnText = $(this).text();
                  if (btnText.startsWith("PULL ") || btnText.startsWith("GET ")) {
                    var getinv;
                    if (btnText.startsWith("PULL ")) {
                      getinv = Module.cwrap('getinventory', 'string', [], { async: false });
                    }
                    else {
                      getinv = Module.cwrap('getfloor', 'string', [], { async: false });
                    }
                    // For some reason, cwrap sometimes (but not always)
                    // returns a promise
                    Promise.resolve(getinv()).then(function (value) {
                      let invstring;
                      if (!value) {
                        // In some cases there is no return value -
                        // this is probably attached to when
                        // a promise is returned. Also, it is always the
                        // first call (but not always - probably a timing
                        // thing.) A bug in emscripten?
                        // For now, make a second call
                        invstring = getinv();
                      }
                      else {
                        invstring = value;
                      }

                      if (!invstring) {
                        // Nothing in inventory
                        $("#second_area").hide();
                        $("#inventory_area").hide();
                        $("#button_area").show();
                        return;
                      }

                      var inventory = invstring.split("|");
                      $("#inventory_area").empty();
                      for (var item of inventory) {
                        if (item != "") {
                          var invButton = $('<button/>')
                            .text(btnText + " " + item)
                            .click(function () {
                              var curText = $(this).text();
                              Module.ccall('sendinput', 'void', ['string'], [curText + "\r"]);
                              $("#second_area").hide();
                              $("#inventory_area").hide();
                              $("#button_area").show();
                            });
                          $("#inventory_area").append(invButton);
                        }
                      }
                      $("#button_area").hide();
                      $("#second_area").hide();
                      $("#inventory_area").show();

                    });
                  }
                  else {
                    var sendText = btnText;
                    if (sendText == "MOVE FORWARD") {
                      // Command only uses "MOVE", but the button displays
                      // MOVE FORWARD
                      sendText = "MOVE";
                    }
                    Module.ccall('sendinput', 'void', ['string'], [sendText + "\r"]);
                    $("#second_area").hide();
                    $("#inventory_area").hide();
                    $("#button_area").show();
                  }
                });
              $("#second_area").append(secondInputButton);
            }
            $("#second_area").show();
          }
        });
      $("#button_area").append(inputButton);
    }

    var menuButton = $('<button/>')
      .text("MENU")
      .click(function () {
        Module.ccall('triggermenu', 'void', []);
      });
    $("#button_area").append(menuButton);

    $("#sendinput").click(function () {
      Module.ccall('sendinput', 'void', ['string'], ["P L T\r"]);
    });

  });

</script>
<script async src=index.js></script>


  
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-33986051-2', 'auto');
    ga('send', 'pageview');
  </script>
  
</body>

</html>
