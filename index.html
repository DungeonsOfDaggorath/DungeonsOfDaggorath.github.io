---
layout: default
---
<div class="container menu_items" id="info">
  <section id="main_content">
    <picture>
      <source type="image/webp" srcset="assets/images/dodtext300.webp" media="(min-width: 300px)"
        title="{{ site.title | default: site.github.repository.name }}">
      <source type="image/png" srcset="assets/images/dodtext300.png" media="(min-width: 300px)"
        title="{{ site.title | default: site.github.repository_name }}">
      <img src="assets/images/dodtext300.png" alt="{{ site.title | default: site.github.repository_name }}">
    </picture>
    <div id="coi-warning" class="alert alert-warning" style="display:none;">
      <strong>Cross-origin isolation required.</strong> The threaded WebAssembly build needs SharedArrayBuffer support.
      Run the site from a server that sets <code>Cross-Origin-Opener-Policy: same-origin</code> and
      <code>Cross-Origin-Embedder-Policy: require-corp</code>.
      For local testing with the Emscripten SDK run <code>make serve</code> or <code>make serve-local</code>.
    </div>
    <p>
      <button id="readyPlayerOne" type="button" class="btn-lg btn-primary btn">Play Dungeons of Daggorath</button><br />
      <!--  <a id="readyPlayerOne" href="#">Start your engines.</a><br/> -->
    <div id="installapp"><a href="#" id="install_link">INSTALL</a></div>
    <a href="about.html">About</a>
    <a href="how.html">How to Play</a>
    <a href="{{site.github.repository_url}}">View on GitHub</a>
  </section>
</div>
<div id="game_area">
  <div class="column_width">
    <div class="width_sizer">
      <div id="frame">
        <figure id=spinner style=overflow:visible>
          <div class=spinner></div>
          <center style=margin-top:.5em><strong>emscripten</strong></center>
        </figure>
        <div class=emscripten id=status>Downloading...</div>
        <div class=emscripten>
          <progress hidden id=progress max=100 value=0></progress>
        </div>
        <canvas class=emscripten id=canvas oncontextmenu=event.preventDefault()></canvas>
      </div>
      <button id="stopdemo" type="button" style="display:none" class="btn-lg btn-primary btn">Stop Demo / Start
        game</button><br />
      <div id="button_area">
      </div>
      <div id="second_area">
      </div>
      <div id="inventory_area">
      </div>
      <div id="menu_nav_area" style="display:none;">
      </div>
      <div id="incant_input_area" style="display:none;">
        <label for="incant_word">Enter magic word:</label>
        <input type="text" id="incant_word" autocomplete="off" autocapitalize="characters" />
        <button id="incant_go">GO</button>
        <button id="incant_cancel">CANCEL</button>
      </div>
    </div>
  </div>
</div>
<script>

  let deferredPrompt;

  window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent the mini-infobar from appearing on mobile
    e.preventDefault();
    // Stash the event so it can be triggered later.
    deferredPrompt = e;
    // update UI notify the user they can install the PWA
    $("#installapp").show();
  });

  $("#install_link").click(function (event) {
    event.preventDefault();

    if (deferredPrompt == null) {
      console.log("Something went wrong here, user clicked the link but no waiting event.");
      return;
    }

    $("#installapp").hide();
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        console.log("User accepted the install prompt");
      }
      else {
        console.log("User dismissed the install prompt");
        $("#installapp").show();
      }
    });
  });


  var inputCommands = {
    "MOVE": ["FORWARD", "BACK", "LEFT", "RIGHT"],
    "TURN": ["LEFT", "RIGHT", "AROUND"],
    "ATTACK": ["LEFT", "RIGHT"],
    "PULL": ["LEFT", "RIGHT"],
    "GET": ["LEFT", "RIGHT"],
    "STOW": ["LEFT", "RIGHT"],
    "CLIMB": ["UP", "DOWN"],
    "EXAMINE": [],
    "LOOK": [],
    "DROP": ["LEFT", "RIGHT"],
    "USE": ["LEFT", "RIGHT"],
    "REVEAL": ["LEFT", "RIGHT"],
    "INCANT": "INPUT",  // Special: shows text input
    "ZSAVE": [],
    "ZLOAD": [],
    "RESTART": "RESTART"  // Special: stops demo first
  };

  // SDL2 key codes for menu navigation
  var SDL_KEYS = {
    RETURN: 13,
    ESCAPE: 27,
    SPACE: 32,
    UP: 1073741906,
    DOWN: 1073741905,
    LEFT: 1073741904,
    RIGHT: 1073741903
  };

  var statusElement = document.getElementById("status");
  var progressElement = document.getElementById("progress");
  var spinnerElement = document.getElementById("spinner");
  (function () {
    var isolationOK = typeof SharedArrayBuffer !== "undefined" && window.crossOriginIsolated === true;
    var warning = document.getElementById("coi-warning");
    var startButton = document.getElementById("readyPlayerOne");
    if (!isolationOK) {
      if (warning) {
        warning.style.display = "block";
      }
      if (startButton) {
        startButton.disabled = true;
      }
    }
  })();

  var Module = {
    preRun: [],
    postRun: [],
    print: function (text) { console.log(text) },
    printErr: function (text) { console.error("ERROR:", text) },
    noExitRuntime: true,
    // Skip calling main
    noInitialRun: true,
    canvas: function () { var e = document.getElementById("canvas"); e.addEventListener("webglcontextlost", function (e) { alert("WebGL context lost. You will need to reload the page."), e.preventDefault() }, !1); console.log("Canvas initial size", e.width, e.height, "offscreen?", !!e.transferControlToOffscreen, e.getBoundingClientRect()); return e }(),
    setStatus: function (e) { if (Module.setStatus.last || (Module.setStatus.last = { time: Date.now(), text: "" }), e !== Module.setStatus.last.text) { var t = e.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/), n = Date.now(); t && n - Module.setStatus.last.time < 30 || (Module.setStatus.last.time = n, Module.setStatus.last.text = e, t ? (e = t[1], progressElement.value = 100 * parseInt(t[2]), progressElement.max = 100 * parseInt(t[4]), progressElement.hidden = !1, spinnerElement.hidden = !1) : (progressElement.value = null, progressElement.max = null, progressElement.hidden = !0, e || (spinnerElement.hidden = !0)), statusElement.innerHTML = e) } },
    totalDependencies: 0,
    monitorRunDependencies: function (e) { this.totalDependencies = Math.max(this.totalDependencies, e), Module.setStatus(e ? "Preparing... (" + (this.totalDependencies - e) + "/" + this.totalDependencies + ")" : "All downloads complete.") }
  };
  Module.setStatus("Downloading..."), window.onerror = function () { Module.setStatus("Exception thrown, see JavaScript console"), spinnerElement.style.display = "none", Module.setStatus = function (e) { e && Module.printErr("[post-exception status] " + e) } }

  var isDemoFunc = null;
  var isMenuOpenFunc = null;
  var sendKeyFunc = null;
  var controlHandler = null;
  var menuCheckHandler = null;
  var wasMenuOpen = false;

  function updateControls() {
    if (!Module.calledRun || typeof isDemoFunc !== 'function') {
      // Not yet ready, just wait
      return;
    }

    var demoActive = !!isDemoFunc();
    if (!demoActive) {
      // Once the demo is no longer active, hide the stop demo button
      // and show the main controls

      // Stop the control handler as the demo is no longer active
      if (controlHandler) {
        clearInterval(controlHandler);
      }
      $("#stopdemo").hide();
      $("#button_area").show();
      $("#second_area").hide();
      $("#inventory_area").hide();

      // Start menu state polling
      if (!menuCheckHandler && typeof isMenuOpenFunc === 'function') {
        menuCheckHandler = setInterval(checkMenuState, 200);
      }
    }
  }

  function checkMenuState() {
    if (typeof isMenuOpenFunc !== 'function') return;

    var menuOpen = !!isMenuOpenFunc();
    if (menuOpen !== wasMenuOpen) {
      wasMenuOpen = menuOpen;
      if (menuOpen) {
        // Menu just opened - show navigation buttons, hide game buttons
        $("#button_area").hide();
        $("#second_area").hide();
        $("#inventory_area").hide();
        $("#incant_input_area").hide();
        $("#menu_nav_area").show();
      } else {
        // Menu just closed - show game buttons, hide navigation
        $("#menu_nav_area").hide();
        $("#button_area").show();
      }
    }
  }

  function showIncantInput() {
    $("#button_area").hide();
    $("#incant_input_area").show();
    var input = document.getElementById('incant_word');
    input.value = '';
    input.focus();
  }

  function hideIncantInput() {
    $("#incant_input_area").hide();
    $("#button_area").show();
  }

  function submitIncant() {
    var input = document.getElementById('incant_word');
    var word = input.value.trim().toUpperCase();
    hideIncantInput();
    if (word) {
      Module.ccall('sendinput', 'void', ['string'], ["INCANT " + word + "\r"]);
    }
  }

  Module.onRuntimeInitialized = function () {
    console.log('[Module] onRuntimeInitialized');
    isDemoFunc = Module.cwrap('isdemo', 'number', []);
    isMenuOpenFunc = Module.cwrap('ismenuopen', 'number', []);
    sendKeyFunc = Module.cwrap('sendkey', 'void', ['number']);
  };

  $(document).ready(function () {
    console.log('[document.ready] initializing control visibility', window.getComputedStyle(document.getElementById('stopdemo')).display, window.getComputedStyle(document.getElementById('button_area')).display);
    $("#stopdemo").hide();
    $("#button_area").hide();
    $("#second_area").hide();
    $("#inventory_area").hide();
    $("#menu_nav_area").hide();
    $("#incant_input_area").hide();
    $("#readyPlayerOne").click(function () {
      console.log('[readyPlayerOne] clicked');
      $("#stopdemo").show();
      $("#frame").show();
      $("#button_area").hide();
      $("#second_area").hide();
      $("#inventory_area").hide();
      $("#menu_nav_area").hide();
      $("#incant_input_area").hide();
      $("#info").hide();
      if (Module.callMain) {
        Module.callMain([]);
      } else if (Module._main) {
        Module._main();
      }
      // Set interval to check for demo status
      // to remove the stop demo button when the
      // demo is no longer active
      controlHandler = setInterval(updateControls, 500);
    });


    $("#stopdemo").click(function () {
      console.log('[stopdemo] clicked', window.getComputedStyle(document.getElementById('stopdemo')).display, window.getComputedStyle(document.getElementById('button_area')).display);
      Module.ccall('stopdemo', 'void', []);
      $("#stopdemo").hide();
    });

    // INCANT input handlers
    $("#incant_go").click(submitIncant);
    $("#incant_cancel").click(hideIncantInput);
    // Use native addEventListener since domlite doesn't support .on()
    document.getElementById('incant_word').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitIncant();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        hideIncantInput();
      }
    });

    // Create menu navigation buttons
    var menuNavButtons = [
      { label: '▲', key: SDL_KEYS.UP },
      { label: '▼', key: SDL_KEYS.DOWN },
      { label: 'SELECT', key: SDL_KEYS.RETURN },
      { label: 'BACK', key: SDL_KEYS.ESCAPE }
    ];
    for (var nav of menuNavButtons) {
      (function(keyCode) {
        var navBtn = $('<button/>')
          .text(nav.label)
          .click(function() {
            if (typeof sendKeyFunc === 'function') {
              sendKeyFunc(keyCode);
            }
          });
        $("#menu_nav_area").append(navBtn);
      })(nav.key);
    }

    for (var command in inputCommands) {
      var inputButton = $('<button/>')
        .text(command)
        .click(function () {
          var curText = $(this).text();

          if (typeof (inputCommands[curText]) != 'undefined') {
            // Special case: INCANT shows text input
            if (inputCommands[curText] === "INPUT") {
              showIncantInput();
              return;
            }

            // Special case: RESTART stops demo first then restarts
            if (inputCommands[curText] === "RESTART") {
              Module.ccall('stopdemo', 'void', []);
              Module.ccall('sendinput', 'void', ['string'], ["RESTART\r"]);
              return;
            }

            if (inputCommands[curText].length == 0) {
              // Single command
              Module.ccall('sendinput', 'void', ['string'], [curText + "\r"]);
              return;
            }


            $("#second_area").empty();
            $("#button_area").hide();
            $("#inventory_area").hide();
            for (var second of inputCommands[curText]) {
              var secondInputButton = $('<button/>')
                .text(curText + " " + second)
                .click(function () {
                  var btnText = $(this).text();
                  if (btnText.startsWith("PULL ") || btnText.startsWith("GET ")) {
                    var getinv;
                    if (btnText.startsWith("PULL ")) {
                      getinv = Module.cwrap('getinventory', 'string', [], { async: false });
                    }
                    else {
                      getinv = Module.cwrap('getfloor', 'string', [], { async: false });
                    }
                    // For some reason, cwrap sometimes (but not always)
                    // returns a promise
                    Promise.resolve(getinv()).then(function (value) {
                      let invstring;
                      if (!value) {
                        // In some cases there is no return value -
                        // this is probably attached to when
                        // a promise is returned. Also, it is always the
                        // first call (but not always - probably a timing
                        // thing.) A bug in emscripten?
                        // For now, make a second call
                        invstring = getinv();
                      }
                      else {
                        invstring = value;
                      }

                      if (!invstring) {
                        // Nothing in inventory
                        $("#second_area").hide();
                        $("#inventory_area").hide();
                        $("#button_area").show();
                        return;
                      }

                      var inventory = invstring.split("|");
                      $("#inventory_area").empty();
                      for (var item of inventory) {
                        if (item != "") {
                          var invButton = $('<button/>')
                            .text(btnText + " " + item)
                            .click(function () {
                              var curText = $(this).text();
                              Module.ccall('sendinput', 'void', ['string'], [curText + "\r"]);
                              $("#second_area").hide();
                              $("#inventory_area").hide();
                              $("#button_area").show();
                            });
                          $("#inventory_area").append(invButton);
                        }
                      }
                      $("#button_area").hide();
                      $("#second_area").hide();
                      $("#inventory_area").show();

                    });
                  }
                  else {
                    var sendText = btnText;
                    if (sendText == "MOVE FORWARD") {
                      // Command only uses "MOVE", but the button displays
                      // MOVE FORWARD
                      sendText = "MOVE";
                    }
                    Module.ccall('sendinput', 'void', ['string'], [sendText + "\r"]);
                    $("#second_area").hide();
                    $("#inventory_area").hide();
                    $("#button_area").show();
                  }
                });
              $("#second_area").append(secondInputButton);
            }
            $("#second_area").show();
          }
        });
      $("#button_area").append(inputButton);
    }

    var menuButton = $('<button/>')
      .text("MENU")
      .click(function () {
        Module.ccall('triggermenu', 'void', []);
      });
    $("#button_area").append(menuButton);

    $("#sendinput").click(function () {
      Module.ccall('sendinput', 'void', ['string'], ["P L T\r"]);
    });

  });

</script>
<script async src=index.js></script>
