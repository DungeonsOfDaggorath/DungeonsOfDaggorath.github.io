<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dungeons of Daggorath (Local)</title>
    <link rel="stylesheet" href="assets/css/emscripten.css">
    <link rel="icon" href="assets/images/favicon.ico">
    <script src="assets/js/domlite.js"></script>
    <style>
      body { margin: 0; background-color: #0e0303; color: #f8f8f2; }
      .local-warning { margin: 1rem auto; max-width: 900px; padding: 1rem; border: 1px solid #f0ad4e; background: rgba(240,173,78,0.15); }
      .local-warning code { background: rgba(0,0,0,0.3); padding: 0.15rem 0.3rem; border-radius: 3px; }

      /* Settings Panel Styles */
      .settings-panel {
        max-width: 600px;
        margin: 1rem auto;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 4px;
        text-align: left;
      }
      .settings-section {
        border-bottom: 1px solid #333;
      }
      .settings-section:last-child {
        border-bottom: none;
      }
      .settings-header {
        width: 100%;
        padding: 12px 16px;
        background: #252525;
        border: none;
        color: #b5e853;
        font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
        font-size: 16px;
        text-align: left;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .settings-header:hover {
        background: #2a2a2a;
      }
      .settings-header:focus {
        outline: 2px solid #b5e853;
        outline-offset: -2px;
      }
      .accordion-arrow {
        font-size: 18px;
        font-weight: bold;
        color: #63c0f5;
      }
      .settings-content {
        display: none;
        padding: 16px;
        background: #1a1a1a;
      }
      .settings-content.open {
        display: block;
      }
      .settings-content label {
        display: flex;
        align-items: center;
        padding: 8px 0;
        min-height: 44px;
        cursor: pointer;
        color: #eaeaea;
        font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
        font-size: 14px;
      }
      .settings-content label:hover {
        color: #b5e853;
      }
      .settings-content input[type="radio"],
      .settings-content input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        cursor: pointer;
        accent-color: #b5e853;
      }
      .settings-content input[type="range"] {
        width: 100%;
        height: 8px;
        margin: 10px 0;
        cursor: pointer;
        accent-color: #b5e853;
      }
      .volume-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #eaeaea;
        font-family: Monaco, monospace;
        font-size: 14px;
      }
      .volume-value {
        color: #b5e853;
        font-weight: bold;
        min-width: 40px;
        text-align: right;
      }
      .mod-description {
        font-size: 12px;
        color: #888;
        margin-left: 32px;
        margin-top: -4px;
        margin-bottom: 8px;
      }

      /* Play Section */
      .play-section {
        margin: 1.5rem 0;
        text-align: center;
      }
      .play-btn {
        font-size: 1.4rem !important;
        padding: 14px 32px !important;
        background: #1a1a1a !important;
        border: 2px solid #b5e853 !important;
        color: #b5e853 !important;
        text-shadow: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        transition: all 0.2s ease;
      }
      .play-btn:hover {
        background: #252525 !important;
        box-shadow: 0 6px 16px rgba(181, 232, 83, 0.3);
        transform: translateY(-1px);
      }
      .play-btn:active {
        transform: translateY(1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      }
      .install-link {
        margin-top: 0.75rem;
        display: none;
      }
      .install-link a {
        color: #63c0f5;
        font-size: 0.9rem;
        text-decoration: none;
        opacity: 0.8;
      }
      .install-link a:hover {
        opacity: 1;
        text-decoration: underline;
      }

      /* Settings Title */
      .settings-title {
        padding: 10px 16px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #666;
        border-bottom: 1px solid #333;
        background: #1a1a1a;
      }

      /* Navigation Links */
      .nav-links {
        margin-top: 1.5rem;
        padding: 1rem 0;
        text-align: center;
        border-top: 1px solid #333;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 4px 0;
      }
      .nav-link {
        color: #63c0f5;
        text-decoration: none;
        font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
        font-size: 14px;
        padding: 8px 12px;
        transition: color 0.2s ease;
        white-space: nowrap;
      }
      .nav-link:hover {
        color: #b5e853;
        text-decoration: none;
      }
      .nav-separator {
        color: #444;
        margin: 0 4px;
      }

      @media (max-width: 480px) {
        .settings-panel {
          margin: 0.5rem;
        }
        .settings-header {
          font-size: 14px;
          padding: 10px 12px;
        }
        .settings-content {
          padding: 12px;
        }
        .settings-content label {
          font-size: 13px;
        }
        .play-btn {
          font-size: 1.2rem !important;
          padding: 12px 24px !important;
        }
        .nav-separator {
          display: none;
        }
        .nav-link {
          padding: 10px 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container menu_items" id="info">
      <section id="main_content">
        <picture>
          <source type="image/webp" srcset="assets/images/dodtext300.webp" media="(min-width: 300px)">
          <source type="image/png" srcset="assets/images/dodtext300.png" media="(min-width: 300px)">
          <img src="assets/images/dodtext300.png" alt="Dungeons of Daggorath">
        </picture>
        <div id="coi-warning" class="local-warning" style="display:none;">
          <strong>Cross-origin isolation required.</strong> The threaded WebAssembly build needs SharedArrayBuffer support.
          Start this page with <code>THREAD_POOL_SIZE=4 make serve-local</code> (default port 8080) so that <code>emrun</code> sets the required headers.
        </div>

        <!-- Play Button - Primary Action -->
        <div class="play-section">
          <button id="readyPlayerOne" type="button" class="btn-lg btn-primary btn play-btn">Play Dungeons of Daggorath</button>
        </div>

        <!-- Settings Panel -->
        <div id="settings_panel" class="settings-panel">
          <div class="settings-title">Game Options</div>
          <!-- Graphics Section -->
          <div class="settings-section">
            <button class="settings-header" type="button" data-section="graphics">
              Graphics <span class="accordion-arrow">+</span>
            </button>
            <div class="settings-content" id="graphics-content">
              <label><input type="radio" name="graphics_mode" value="normal_ntsc"> NORMAL - NTSC</label>
              <label><input type="radio" name="graphics_mode" value="normal_ntsc_inv"> NORMAL - NTSC INV</label>
              <label><input type="radio" name="graphics_mode" value="normal_rgb"> NORMAL - RGB</label>
              <label><input type="radio" name="graphics_mode" value="hires_ntsc"> HIRES - NTSC</label>
              <label><input type="radio" name="graphics_mode" value="hires_ntsc_inv"> HIRES - NTSC INV</label>
              <label><input type="radio" name="graphics_mode" value="hires_rgb"> HIRES - RGB</label>
              <label><input type="radio" name="graphics_mode" value="vector"> VECTOR</label>
            </div>
          </div>

          <!-- Volume Section -->
          <div class="settings-section">
            <button class="settings-header" type="button" data-section="volume">
              Volume <span class="accordion-arrow">+</span>
            </button>
            <div class="settings-content" id="volume-content">
              <div class="volume-display">
                <span>Volume</span>
                <span class="volume-value" id="volume-value">128</span>
              </div>
              <input type="range" id="volume-slider" name="volume" min="0" max="128" value="128">
            </div>
          </div>

          <!-- Mods Section -->
          <div class="settings-section">
            <button class="settings-header" type="button" data-section="mods">
              Mods <span class="accordion-arrow">+</span>
            </button>
            <div class="settings-content" id="mods-content">
              <label><input type="checkbox" name="mod" value="shield_fix"> Shield Fix</label>
              <div class="mod-description">Fixes shield mechanics bug from original</div>
              <label><input type="checkbox" name="mod" value="vision_scroll"> Vision Scroll</label>
              <div class="mod-description">Vision scrolls with map movement</div>
              <label><input type="checkbox" name="mod" value="mark_doors"> Mark Doors on Maps</label>
              <div class="mod-description">Shows doors on scroll maps</div>
              <label><input type="checkbox" name="mod" value="creatures_ignore_objects"> Creatures Ignore Objects</label>
              <div class="mod-description">Creatures don't interact with objects</div>
              <label><input type="checkbox" name="mod" value="creatures_insta_regen"> Creatures Insta-Regen</label>
              <div class="mod-description">Creatures regenerate instantly</div>
              <label><input type="checkbox" name="mod" value="random_mazes"> Random Mazes</label>
              <div class="mod-description">Enables random maze generation</div>
              <label><input type="checkbox" name="mod" value="modern_controls"> Modern Controls</label>
              <div class="mod-description">Arrow keys + TAB for controls</div>
            </div>
          </div>
        </div>

        <!-- Navigation Links -->
        <nav class="nav-links">
          <a href="about.html" class="nav-link">About</a>
          <span class="nav-separator">|</span>
          <a href="how.html" class="nav-link">How to Play</a>
          <span class="nav-separator">|</span>
          <a href="https://github.com/cognitivegears/DungeonsOfDaggorath.github.io" class="nav-link">View on GitHub</a>
        </nav>
      </section>
    </div>
    <div id="game_area">
      <div class="column_width">
        <div class="width_sizer">
          <div id="frame">
            <figure id="spinner" style="overflow:visible">
              <div class="spinner"></div>
              <center style="margin-top:.5em"><strong>emscripten</strong></center>
            </figure>
            <div class="emscripten" id="status">Downloading...</div>
            <div class="emscripten">
              <progress hidden id="progress" max="100" value="0"></progress>
            </div>
            <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
          </div>
          <button id="stopdemo" type="button" style="display:none" class="btn-lg btn-primary btn">Stop Demo / Start game</button>
          <div id="button_area">
          </div>
          <div id="second_area"></div>
          <div id="inventory_area"></div>
          <div id="menu_nav_area" style="display:none;">
          </div>
          <div id="incant_input_area" style="display:none;">
            <label for="incant_word">Enter magic word:</label>
            <input type="text" id="incant_word" autocomplete="off" autocapitalize="characters" />
            <button id="incant_go">GO</button>
            <button id="incant_cancel">CANCEL</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let deferredPrompt;

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
      });

      (function() {
        var isolationOK = typeof SharedArrayBuffer !== "undefined" && window.crossOriginIsolated === true;
        var warning = document.getElementById("coi-warning");
        var startButton = document.getElementById("readyPlayerOne");
        if (!isolationOK) {
          if (warning) warning.style.display = "block";
          if (startButton) startButton.disabled = true;
        }
      })();

      // Game Configuration Module
      var GameConfig = {
        validGraphicsModes: ['vector', 'normal_rgb', 'normal_ntsc', 'normal_ntsc_inv', 'hires_rgb', 'hires_ntsc', 'hires_ntsc_inv'],
        validMods: ['shield_fix', 'vision_scroll', 'mark_doors', 'creatures_ignore_objects', 'creatures_insta_regen', 'random_mazes', 'modern_controls'],
        validCheats: ['torch_always_lit', 'ring_always_works', 'creature_scaling', 'mithril_items', 'easy_reveal', 'invulnerable'],

        parseParams: function() {
          var params = new URLSearchParams(window.location.search);
          var settings = {
            graphics_mode: null,
            volume: null,
            mods: [],
            cheats: []
          };

          var gm = params.get('graphics_mode');
          if (gm && this.validGraphicsModes.indexOf(gm) !== -1) {
            settings.graphics_mode = gm;
          }

          var vol = params.get('volume');
          if (vol !== null) {
            var v = parseInt(vol, 10);
            if (!isNaN(v) && v >= 0 && v <= 128) {
              settings.volume = v;
            }
          }

          var mods = params.getAll('mod');
          for (var i = 0; i < mods.length; i++) {
            if (this.validMods.indexOf(mods[i]) !== -1 && settings.mods.indexOf(mods[i]) === -1) {
              settings.mods.push(mods[i]);
            }
          }

          var cheats = params.getAll('cheat');
          for (var i = 0; i < cheats.length; i++) {
            if (this.validCheats.indexOf(cheats[i]) !== -1 && settings.cheats.indexOf(cheats[i]) === -1) {
              settings.cheats.push(cheats[i]);
            }
          }

          return settings;
        },

        buildConfigString: function(settings) {
          var parts = [];
          if (settings.graphics_mode) {
            parts.push('graphics_mode=' + settings.graphics_mode);
          }
          if (settings.volume !== null) {
            parts.push('volume=' + settings.volume);
          }
          for (var i = 0; i < settings.mods.length; i++) {
            parts.push('mod=' + settings.mods[i]);
          }
          for (var i = 0; i < settings.cheats.length; i++) {
            parts.push('cheat=' + settings.cheats[i]);
          }
          return parts.join('|');
        },

        readFormValues: function() {
          var settings = {
            graphics_mode: null,
            volume: null,
            mods: [],
            cheats: []
          };

          var graphicsRadio = document.querySelector('input[name="graphics_mode"]:checked');
          if (graphicsRadio) {
            settings.graphics_mode = graphicsRadio.value;
          }

          var volumeSlider = document.getElementById('volume-slider');
          if (volumeSlider) {
            settings.volume = parseInt(volumeSlider.value, 10);
          }

          var modCheckboxes = document.querySelectorAll('input[name="mod"]:checked');
          modCheckboxes.forEach(function(cb) {
            settings.mods.push(cb.value);
          });

          return settings;
        },

        updateUrl: function(settings) {
          var params = new URLSearchParams();
          if (settings.graphics_mode) {
            params.set('graphics_mode', settings.graphics_mode);
          }
          if (settings.volume !== null && settings.volume !== 128) {
            params.set('volume', settings.volume);
          }
          for (var i = 0; i < settings.mods.length; i++) {
            params.append('mod', settings.mods[i]);
          }
          var currentCheats = this.parseParams().cheats;
          for (var i = 0; i < currentCheats.length; i++) {
            params.append('cheat', currentCheats[i]);
          }

          var newUrl = window.location.pathname;
          var paramString = params.toString();
          if (paramString) {
            newUrl += '?' + paramString;
          }
          window.location.href = newUrl;
        },

        initializeForm: function() {
          var settings = this.parseParams();

          var graphicsValue = settings.graphics_mode || 'normal_ntsc';
          var graphicsRadio = document.querySelector('input[name="graphics_mode"][value="' + graphicsValue + '"]');
          if (graphicsRadio) {
            graphicsRadio.checked = true;
          }

          var volumeSlider = document.getElementById('volume-slider');
          var volumeDisplay = document.getElementById('volume-value');
          var volumeValue = settings.volume !== null ? settings.volume : 128;
          if (volumeSlider) {
            volumeSlider.value = volumeValue;
          }
          if (volumeDisplay) {
            volumeDisplay.textContent = volumeValue;
          }

          for (var i = 0; i < settings.mods.length; i++) {
            var modCheckbox = document.querySelector('input[name="mod"][value="' + settings.mods[i] + '"]');
            if (modCheckbox) {
              modCheckbox.checked = true;
            }
          }
        }
      };

      var inputCommands = {
        "MOVE": ["FORWARD", "BACK", "LEFT", "RIGHT"],
        "TURN": ["LEFT", "RIGHT", "AROUND"],
        "ATTACK": ["LEFT", "RIGHT"],
        "PULL": ["LEFT", "RIGHT"],
        "GET": ["LEFT", "RIGHT"],
        "STOW": ["LEFT", "RIGHT"],
        "CLIMB": ["UP", "DOWN"],
        "EXAMINE": [],
        "LOOK": [],
        "DROP": ["LEFT", "RIGHT"],
        "USE": ["LEFT", "RIGHT"],
        "REVEAL": ["LEFT", "RIGHT"],
        "INCANT": "INPUT",  // Special: shows text input
        "ZSAVE": [],
        "ZLOAD": [],
        "RESTART": "RESTART"  // Special: stops demo first
      };

      // SDL2 key codes for menu navigation
      var SDL_KEYS = {
        RETURN: 13,
        ESCAPE: 27,
        SPACE: 32,
        UP: 1073741906,
        DOWN: 1073741905,
        LEFT: 1073741904,
        RIGHT: 1073741903
      };

      var statusElement = document.getElementById("status");
      var progressElement = document.getElementById("progress");
      var spinnerElement = document.getElementById("spinner");
      var Module = {
        preRun: [],
        postRun: [],
        print: function(text) { console.log(text); },
        printErr: function(text) { console.error("ERROR:", text); },
        noExitRuntime: true,
        noInitialRun: true,
        canvas: (function() {
          var canvas = document.getElementById("canvas");
          canvas.addEventListener("webglcontextlost", function(e) {
            alert("WebGL context lost. You will need to reload the page.");
            e.preventDefault();
          }, false);
          console.log("Canvas initial size", canvas.width, canvas.height, "offscreen?", !!canvas.transferControlToOffscreen, canvas.getBoundingClientRect());
          return canvas;
        })(),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: "" };
          if (text === Module.setStatus.last.text) return;
          var match = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (match && now - Module.setStatus.last.time < 30) return;
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (match) {
            text = match[1];
            progressElement.value = 100 * parseInt(match[2]);
            progressElement.max = 100 * parseInt(match[4]);
            progressElement.hidden = false;
            spinnerElement.hidden = false;
          } else {
            progressElement.value = null;
            progressElement.max = null;
            progressElement.hidden = true;
            if (!text) spinnerElement.hidden = true;
          }
          statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? "Preparing... (" + (this.totalDependencies - left) + "/" + this.totalDependencies + ")" : "All downloads complete.");
        }
      };
      Module.setStatus("Downloading...");
      window.onerror = function() {
        Module.setStatus("Exception thrown, see JavaScript console");
        spinnerElement.style.display = "none";
        Module.setStatus = function(text) {
          if (text) Module.printErr("[post-exception status] " + text);
        };
      };

      var controlHandler = null;
      var menuCheckHandler = null;
      var isDemoFunc = null;
      var isMenuOpenFunc = null;
      var sendKeyFunc = null;
      var wasMenuOpen = false;

      function updateControls() {
        if (!Module.calledRun) {
          $("#stopdemo").show();
          $("#button_area").hide();
          $("#second_area").hide();
          $("#inventory_area").hide();
          return;
        }
        if (typeof isDemoFunc !== "function") {
          $("#stopdemo").show();
          $("#button_area").hide();
          $("#second_area").hide();
          $("#inventory_area").hide();
          return;
        }
        var demoActive = !!isDemoFunc();
        if (!demoActive) {
          // Once the demo is no longer active, hide the stop demo button
          // and show the main controls

          // Disable the control handler as we no longer need to check for demo status
          if(controlHandler) {
            clearInterval(controlHandler);
          }

          $("#stopdemo").hide();
          $("#button_area").show();
          $("#second_area").hide();
          $("#inventory_area").hide();

          // Start menu state polling
          if (!menuCheckHandler && typeof isMenuOpenFunc === 'function') {
            menuCheckHandler = setInterval(checkMenuState, 200);
          }
        }
      }

      function checkMenuState() {
        if (typeof isMenuOpenFunc !== 'function') return;

        var menuOpen = !!isMenuOpenFunc();
        if (menuOpen !== wasMenuOpen) {
          wasMenuOpen = menuOpen;
          if (menuOpen) {
            // Menu just opened - show navigation buttons, hide game buttons
            $("#button_area").hide();
            $("#second_area").hide();
            $("#inventory_area").hide();
            $("#incant_input_area").hide();
            $("#menu_nav_area").show();
          } else {
            // Menu just closed - show game buttons, hide navigation
            $("#menu_nav_area").hide();
            $("#button_area").show();
          }
        }
      }

      function showIncantInput() {
        $("#button_area").hide();
        $("#incant_input_area").show();
        var input = document.getElementById('incant_word');
        input.value = '';
        input.focus();
      }

      function hideIncantInput() {
        $("#incant_input_area").hide();
        $("#button_area").show();
      }

      function submitIncant() {
        var input = document.getElementById('incant_word');
        var word = input.value.trim().toUpperCase();
        hideIncantInput();
        if (word) {
          Module.ccall('sendinput', 'void', ['string'], ["INCANT " + word + "\r"]);
        }
      }

      Module.onRuntimeInitialized = function() {
        isDemoFunc = Module.cwrap("isdemo", "number", []);
        isMenuOpenFunc = Module.cwrap('ismenuopen', 'number', []);
        sendKeyFunc = Module.cwrap('sendkey', 'void', ['number']);
      };

      $(document).ready(function () {
        console.log('[document.ready] initializing control visibility', window.getComputedStyle(document.getElementById('stopdemo')).display, window.getComputedStyle(document.getElementById('button_area')).display);
        $("#stopdemo").hide();
        $("#button_area").hide();
        $("#second_area").hide();
        $("#inventory_area").hide();
        $("#menu_nav_area").hide();
        $("#incant_input_area").hide();

        // Initialize settings form from URL params
        GameConfig.initializeForm();

        // Accordion toggle handlers
        document.querySelectorAll('.settings-header').forEach(function(header) {
          header.addEventListener('click', function() {
            var section = this.getAttribute('data-section');
            var content = document.getElementById(section + '-content');
            var arrow = this.querySelector('.accordion-arrow');

            if (content.classList.contains('open')) {
              content.classList.remove('open');
              arrow.textContent = '+';
            } else {
              document.querySelectorAll('.settings-content').forEach(function(c) {
                c.classList.remove('open');
              });
              document.querySelectorAll('.accordion-arrow').forEach(function(a) {
                a.textContent = '+';
              });
              content.classList.add('open');
              arrow.textContent = '-';
            }
          });
        });

        // Volume slider real-time display update
        var volumeSlider = document.getElementById('volume-slider');
        var volumeDisplay = document.getElementById('volume-value');
        if (volumeSlider && volumeDisplay) {
          volumeSlider.addEventListener('input', function() {
            volumeDisplay.textContent = this.value;
          });
        }

        // Form change handlers - update URL on change
        document.querySelectorAll('#settings_panel input[type="radio"], #settings_panel input[type="checkbox"]').forEach(function(input) {
          input.addEventListener('change', function() {
            var settings = GameConfig.readFormValues();
            GameConfig.updateUrl(settings);
          });
        });

        if (volumeSlider) {
          volumeSlider.addEventListener('change', function() {
            var settings = GameConfig.readFormValues();
            GameConfig.updateUrl(settings);
          });
        }

        $("#readyPlayerOne").click(function () {
          console.log('[readyPlayerOne] clicked');
          $("#stopdemo").show();
          $("#frame").show();
          $("#button_area").hide();
          $("#second_area").hide();
          $("#inventory_area").hide();
          $("#menu_nav_area").hide();
          $("#incant_input_area").hide();
          $("#info").hide();

          if (Module.callMain) {
            Module.callMain([]);
          } else if (Module._main) {
            Module._main();
          }

          // Apply URL configuration AFTER game initialization
          // (loadOptFile has already run, so we can override settings)
          try {
            var applyConfigFunc = Module.cwrap('applyconfig', 'void', ['string']);
            var settings = GameConfig.parseParams();
            var configStr = GameConfig.buildConfigString(settings);
            if (configStr) {
              console.log('[Game] Applying config:', configStr);
              applyConfigFunc(configStr);
            }
          } catch (e) {
            console.warn('[Game] Could not apply config:', e);
          }

          // Start the control handler to hide the stop demo button
          // when the demo is not active
          controlHandler = setInterval(updateControls, 500);
        });

        // INCANT input handlers
        $("#incant_go").click(submitIncant);
        $("#incant_cancel").click(hideIncantInput);
        // Use native addEventListener since domlite doesn't support .on()
        document.getElementById('incant_word').addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            submitIncant();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            hideIncantInput();
          }
        });

        // Create menu navigation buttons
        var menuNavButtons = [
          { label: '▲', key: SDL_KEYS.UP },
          { label: '▼', key: SDL_KEYS.DOWN },
          { label: 'SELECT', key: SDL_KEYS.RETURN },
          { label: 'BACK', key: SDL_KEYS.ESCAPE }
        ];
        for (var nav of menuNavButtons) {
          (function(keyCode) {
            var navBtn = $('<button/>')
              .text(nav.label)
              .click(function() {
                if (typeof sendKeyFunc === 'function') {
                  sendKeyFunc(keyCode);
                }
              });
            $("#menu_nav_area").append(navBtn);
          })(nav.key);
        }

        var menuButton = $('<button/>')
          .text("MENU")
          .click(function() {
            Module.ccall('triggermenu','void',[]);
          });
        $("#button_area").append(menuButton);

        $("#stopdemo").click(function () {
          Module.ccall('stopdemo', 'void', []);
          $("#stopdemo").hide();
        });

        for (var command in inputCommands) {
          var inputButton = $('<button/>')
            .text(command)
            .click(function() {
              var curText = $(this).text();
              if (typeof(inputCommands[curText]) !== 'undefined') {
                // Special case: INCANT shows text input
                if (inputCommands[curText] === "INPUT") {
                  showIncantInput();
                  return;
                }

                // Special case: RESTART stops demo first then restarts
                if (inputCommands[curText] === "RESTART") {
                  Module.ccall('stopdemo', 'void', []);
                  Module.ccall('sendinput', 'void', ['string'], ["RESTART\r"]);
                  return;
                }

                if (inputCommands[curText].length === 0) {
                  Module.ccall('sendinput','void',['string'],[curText + "\r"]);
                  return;
                }
                $("#second_area").empty();
                $("#button_area").hide();
                $("#inventory_area").hide();
                for (var i = 0; i < inputCommands[curText].length; ++i) {
                  (function(second) {
                    var secondInputButton = $('<button/>')
                      .text(curText + " " + second)
                      .click(function() {
                        var btnText = $(this).text();
                        if (btnText.startsWith("PULL ") || btnText.startsWith("GET ")) {
                          var getinv = btnText.startsWith("PULL ")
                            ? Module.cwrap('getinventory','string',[], {async: false})
                            : Module.cwrap('getfloor','string',[], {async: false});
                          Promise.resolve(getinv()).then(function(value) {
                            let invstring;
                            if (!value) {
                              // Sometimes cwrap returns a promise; make a second call if needed.
                              invstring = getinv();
                            } else {
                              invstring = value;
                            }

                            if (!invstring) {
                              $("#second_area").hide();
                              $("#inventory_area").hide();
                              $("#button_area").show();
                              return;
                            }

                            var inventory = invstring.split("|");
                            $("#inventory_area").empty();
                            for (var item of inventory) {
                              if (item !== "") {
                                var invButton = $('<button/>')
                                  .text(btnText + " " + item)
                                  .click(function() {
                                    var curText = $(this).text();
                                    Module.ccall('sendinput','void',['string'],[curText + "\r"]);
                                    $("#second_area").hide();
                                    $("#inventory_area").hide();
                                    $("#button_area").show();
                                  });
                                $("#inventory_area").append(invButton);
                              }
                            }
                            $("#button_area").hide();
                            $("#second_area").hide();
                            $("#inventory_area").show();
                          });
                        } else {
                          var sendText = btnText;
                          if (sendText === "MOVE FORWARD") {
                            // Underlying command expects only "MOVE"
                            sendText = "MOVE";
                          }
                          Module.ccall('sendinput','void',['string'],[sendText + "\r"]);
                          $("#second_area").hide();
                          $("#inventory_area").hide();
                          $("#button_area").show();
                        }
                      });
                    $("#second_area").append(secondInputButton);
                  })(inputCommands[curText][i]);
                }
                $("#second_area").show();
              }

            });
          $("#button_area").append(inputButton);
        }
      });
    </script>
    <script src="index.js"></script>
  </body>
</html>
