<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dungeons of Daggorath (Local)</title>
    <link rel="stylesheet" href="assets/css/emscripten.css">
    <link rel="icon" href="assets/images/favicon.ico">
    <script src="assets/js/domlite.js"></script>
    <style>
      body { margin: 0; background-color: #0e0303; color: #f8f8f2; }
      .local-warning { margin: 1rem auto; max-width: 900px; padding: 1rem; border: 1px solid #f0ad4e; background: rgba(240,173,78,0.15); }
      .local-warning code { background: rgba(0,0,0,0.3); padding: 0.15rem 0.3rem; border-radius: 3px; }
    </style>
  </head>
  <body>
    <div class="container menu_items" id="info">
      <section id="main_content">
        <picture>
          <source type="image/webp" srcset="assets/images/dodtext300.webp" media="(min-width: 300px)">
          <source type="image/png" srcset="assets/images/dodtext300.png" media="(min-width: 300px)">
          <img src="assets/images/dodtext300.png" alt="Dungeons of Daggorath">
        </picture>
        <div id="coi-warning" class="local-warning" style="display:none;">
          <strong>Cross-origin isolation required.</strong> The threaded WebAssembly build needs SharedArrayBuffer support.
          Start this page with <code>THREAD_POOL_SIZE=4 make serve-local</code> (default port 8080) so that <code>emrun</code> sets the required headers.
        </div>
        <p>
          <button id="readyPlayerOne" type="button" class="btn-lg btn-primary btn">Play Dungeons of Daggorath</button>
        </p>
        <p>
          <a href="about.html">About</a>
          <a href="how.html">How to Play</a>
          <a href="https://github.com/cognitivegears/DungeonsOfDaggorath.github.io">View on GitHub</a>
        </p>
      </section>
    </div>
    <div id="game_area">
      <div class="column_width">
        <div class="width_sizer">
          <div id="frame">
            <figure id="spinner" style="overflow:visible">
              <div class="spinner"></div>
              <center style="margin-top:.5em"><strong>emscripten</strong></center>
            </figure>
            <div class="emscripten" id="status">Downloading...</div>
            <div class="emscripten">
              <progress hidden id="progress" max="100" value="0"></progress>
            </div>
            <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
          </div>
          <button id="stopdemo" type="button" style="display:none" class="btn-lg btn-primary btn">Stop Demo / Start game</button>
          <div id="button_area">
          </div>
          <div id="second_area"></div>
          <div id="inventory_area"></div>
          <div id="menu_nav_area" style="display:none;">
          </div>
          <div id="incant_input_area" style="display:none;">
            <label for="incant_word">Enter magic word:</label>
            <input type="text" id="incant_word" autocomplete="off" autocapitalize="characters" />
            <button id="incant_go">GO</button>
            <button id="incant_cancel">CANCEL</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let deferredPrompt;

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
      });

      (function() {
        var isolationOK = typeof SharedArrayBuffer !== "undefined" && window.crossOriginIsolated === true;
        var warning = document.getElementById("coi-warning");
        var startButton = document.getElementById("readyPlayerOne");
        if (!isolationOK) {
          if (warning) warning.style.display = "block";
          if (startButton) startButton.disabled = true;
        }
      })();

      var inputCommands = {
        "MOVE": ["FORWARD", "BACK", "LEFT", "RIGHT"],
        "TURN": ["LEFT", "RIGHT", "AROUND"],
        "ATTACK": ["LEFT", "RIGHT"],
        "PULL": ["LEFT", "RIGHT"],
        "GET": ["LEFT", "RIGHT"],
        "STOW": ["LEFT", "RIGHT"],
        "CLIMB": ["UP", "DOWN"],
        "EXAMINE": [],
        "LOOK": [],
        "DROP": ["LEFT", "RIGHT"],
        "USE": ["LEFT", "RIGHT"],
        "REVEAL": ["LEFT", "RIGHT"],
        "INCANT": "INPUT",  // Special: shows text input
        "ZSAVE": [],
        "ZLOAD": [],
        "RESTART": "RESTART"  // Special: stops demo first
      };

      // SDL2 key codes for menu navigation
      var SDL_KEYS = {
        RETURN: 13,
        ESCAPE: 27,
        SPACE: 32,
        UP: 1073741906,
        DOWN: 1073741905,
        LEFT: 1073741904,
        RIGHT: 1073741903
      };

      var statusElement = document.getElementById("status");
      var progressElement = document.getElementById("progress");
      var spinnerElement = document.getElementById("spinner");
      var Module = {
        preRun: [],
        postRun: [],
        print: function(text) { console.log(text); },
        printErr: function(text) { console.error("ERROR:", text); },
        noExitRuntime: true,
        noInitialRun: true,
        canvas: (function() {
          var canvas = document.getElementById("canvas");
          canvas.addEventListener("webglcontextlost", function(e) {
            alert("WebGL context lost. You will need to reload the page.");
            e.preventDefault();
          }, false);
          console.log("Canvas initial size", canvas.width, canvas.height, "offscreen?", !!canvas.transferControlToOffscreen, canvas.getBoundingClientRect());
          return canvas;
        })(),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: "" };
          if (text === Module.setStatus.last.text) return;
          var match = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (match && now - Module.setStatus.last.time < 30) return;
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (match) {
            text = match[1];
            progressElement.value = 100 * parseInt(match[2]);
            progressElement.max = 100 * parseInt(match[4]);
            progressElement.hidden = false;
            spinnerElement.hidden = false;
          } else {
            progressElement.value = null;
            progressElement.max = null;
            progressElement.hidden = true;
            if (!text) spinnerElement.hidden = true;
          }
          statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? "Preparing... (" + (this.totalDependencies - left) + "/" + this.totalDependencies + ")" : "All downloads complete.");
        }
      };
      Module.setStatus("Downloading...");
      window.onerror = function() {
        Module.setStatus("Exception thrown, see JavaScript console");
        spinnerElement.style.display = "none";
        Module.setStatus = function(text) {
          if (text) Module.printErr("[post-exception status] " + text);
        };
      };

      var controlHandler = null;
      var menuCheckHandler = null;
      var isDemoFunc = null;
      var isMenuOpenFunc = null;
      var sendKeyFunc = null;
      var wasMenuOpen = false;

      function updateControls() {
        if (!Module.calledRun) {
          $("#stopdemo").show();
          $("#button_area").hide();
          $("#second_area").hide();
          $("#inventory_area").hide();
          return;
        }
        if (typeof isDemoFunc !== "function") {
          $("#stopdemo").show();
          $("#button_area").hide();
          $("#second_area").hide();
          $("#inventory_area").hide();
          return;
        }
        var demoActive = !!isDemoFunc();
        if (!demoActive) {
          // Once the demo is no longer active, hide the stop demo button
          // and show the main controls

          // Disable the control handler as we no longer need to check for demo status
          if(controlHandler) {
            clearInterval(controlHandler);
          }

          $("#stopdemo").hide();
          $("#button_area").show();
          $("#second_area").hide();
          $("#inventory_area").hide();

          // Start menu state polling
          if (!menuCheckHandler && typeof isMenuOpenFunc === 'function') {
            menuCheckHandler = setInterval(checkMenuState, 200);
          }
        }
      }

      function checkMenuState() {
        if (typeof isMenuOpenFunc !== 'function') return;

        var menuOpen = !!isMenuOpenFunc();
        if (menuOpen !== wasMenuOpen) {
          wasMenuOpen = menuOpen;
          if (menuOpen) {
            // Menu just opened - show navigation buttons, hide game buttons
            $("#button_area").hide();
            $("#second_area").hide();
            $("#inventory_area").hide();
            $("#incant_input_area").hide();
            $("#menu_nav_area").show();
          } else {
            // Menu just closed - show game buttons, hide navigation
            $("#menu_nav_area").hide();
            $("#button_area").show();
          }
        }
      }

      function showIncantInput() {
        $("#button_area").hide();
        $("#incant_input_area").show();
        var input = document.getElementById('incant_word');
        input.value = '';
        input.focus();
      }

      function hideIncantInput() {
        $("#incant_input_area").hide();
        $("#button_area").show();
      }

      function submitIncant() {
        var input = document.getElementById('incant_word');
        var word = input.value.trim().toUpperCase();
        hideIncantInput();
        if (word) {
          Module.ccall('sendinput', 'void', ['string'], ["INCANT " + word + "\r"]);
        }
      }

      Module.onRuntimeInitialized = function() {
        isDemoFunc = Module.cwrap("isdemo", "number", []);
        isMenuOpenFunc = Module.cwrap('ismenuopen', 'number', []);
        sendKeyFunc = Module.cwrap('sendkey', 'void', ['number']);
      };

      $(document).ready(function () {
        console.log('[document.ready] initializing control visibility', window.getComputedStyle(document.getElementById('stopdemo')).display, window.getComputedStyle(document.getElementById('button_area')).display);
        $("#stopdemo").hide();
        $("#button_area").hide();
        $("#second_area").hide();
        $("#inventory_area").hide();
        $("#menu_nav_area").hide();
        $("#incant_input_area").hide();
        $("#readyPlayerOne").click(function () {
          console.log('[readyPlayerOne] clicked');
          $("#stopdemo").show();
          $("#frame").show();
          $("#button_area").hide();
          $("#second_area").hide();
          $("#inventory_area").hide();
          $("#menu_nav_area").hide();
          $("#incant_input_area").hide();
          $("#info").hide();
          // Start the control handler to hide the stop demo button
          // when the demo is not active
          controlHandler = setInterval(updateControls, 500);

          if (Module.callMain) {
            Module.callMain([]);
          } else if (Module._main) {
            Module._main();
          }
        });

        // INCANT input handlers
        $("#incant_go").click(submitIncant);
        $("#incant_cancel").click(hideIncantInput);
        // Use native addEventListener since domlite doesn't support .on()
        document.getElementById('incant_word').addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            submitIncant();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            hideIncantInput();
          }
        });

        // Create menu navigation buttons
        var menuNavButtons = [
          { label: '▲', key: SDL_KEYS.UP },
          { label: '▼', key: SDL_KEYS.DOWN },
          { label: 'SELECT', key: SDL_KEYS.RETURN },
          { label: 'BACK', key: SDL_KEYS.ESCAPE }
        ];
        for (var nav of menuNavButtons) {
          (function(keyCode) {
            var navBtn = $('<button/>')
              .text(nav.label)
              .click(function() {
                if (typeof sendKeyFunc === 'function') {
                  sendKeyFunc(keyCode);
                }
              });
            $("#menu_nav_area").append(navBtn);
          })(nav.key);
        }

        var menuButton = $('<button/>')
          .text("MENU")
          .click(function() {
            Module.ccall('triggermenu','void',[]);
          });
        $("#button_area").append(menuButton);

        $("#stopdemo").click(function () {
          Module.ccall('stopdemo', 'void', []);
          $("#stopdemo").hide();
        });

        for (var command in inputCommands) {
          var inputButton = $('<button/>')
            .text(command)
            .click(function() {
              var curText = $(this).text();
              if (typeof(inputCommands[curText]) !== 'undefined') {
                // Special case: INCANT shows text input
                if (inputCommands[curText] === "INPUT") {
                  showIncantInput();
                  return;
                }

                // Special case: RESTART stops demo first then restarts
                if (inputCommands[curText] === "RESTART") {
                  Module.ccall('stopdemo', 'void', []);
                  Module.ccall('sendinput', 'void', ['string'], ["RESTART\r"]);
                  return;
                }

                if (inputCommands[curText].length === 0) {
                  Module.ccall('sendinput','void',['string'],[curText + "\r"]);
                  return;
                }
                $("#second_area").empty();
                $("#button_area").hide();
                $("#inventory_area").hide();
                for (var i = 0; i < inputCommands[curText].length; ++i) {
                  (function(second) {
                    var secondInputButton = $('<button/>')
                      .text(curText + " " + second)
                      .click(function() {
                        var btnText = $(this).text();
                        if (btnText.startsWith("PULL ") || btnText.startsWith("GET ")) {
                          var getinv = btnText.startsWith("PULL ")
                            ? Module.cwrap('getinventory','string',[], {async: false})
                            : Module.cwrap('getfloor','string',[], {async: false});
                          Promise.resolve(getinv()).then(function(value) {
                            let invstring;
                            if (!value) {
                              // Sometimes cwrap returns a promise; make a second call if needed.
                              invstring = getinv();
                            } else {
                              invstring = value;
                            }

                            if (!invstring) {
                              $("#second_area").hide();
                              $("#inventory_area").hide();
                              $("#button_area").show();
                              return;
                            }

                            var inventory = invstring.split("|");
                            $("#inventory_area").empty();
                            for (var item of inventory) {
                              if (item !== "") {
                                var invButton = $('<button/>')
                                  .text(btnText + " " + item)
                                  .click(function() {
                                    var curText = $(this).text();
                                    Module.ccall('sendinput','void',['string'],[curText + "\r"]);
                                    $("#second_area").hide();
                                    $("#inventory_area").hide();
                                    $("#button_area").show();
                                  });
                                $("#inventory_area").append(invButton);
                              }
                            }
                            $("#button_area").hide();
                            $("#second_area").hide();
                            $("#inventory_area").show();
                          });
                        } else {
                          var sendText = btnText;
                          if (sendText === "MOVE FORWARD") {
                            // Underlying command expects only "MOVE"
                            sendText = "MOVE";
                          }
                          Module.ccall('sendinput','void',['string'],[sendText + "\r"]);
                          $("#second_area").hide();
                          $("#inventory_area").hide();
                          $("#button_area").show();
                        }
                      });
                    $("#second_area").append(secondInputButton);
                  })(inputCommands[curText][i]);
                }
                $("#second_area").show();
              }

            });
          $("#button_area").append(inputButton);
        }
      });
    </script>
    <script src="index.js"></script>
  </body>
</html>
